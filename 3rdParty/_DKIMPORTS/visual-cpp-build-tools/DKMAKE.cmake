#!/usr/bin/cmake -P
if(NOT DKCMAKE_FUNCTIONS_DIR_)
	set(DKCMAKE_FUNCTIONS_DIR_ ${CMAKE_SOURCE_DIR}/../../../DKCMake/functions/)
endif()
include(${DKCMAKE_FUNCTIONS_DIR_}DK.cmake)


###### visual-cpp-build-tools ######
dk_validate(host_triple "dk_host_triple()")
if(NOT WIN_HOST)
	dk_undepend(visual-cpp-build-tools)
	dk_return()
endif()


### VERSION ###
dk_set(VISUAL_CPP_BUILD_TOOLS_VERSION 	17)
#dk_set(VISUAL_CPP_BUILD_TOOLS_DL 		"https://aka.ms/vs/${VISUAL_CPP_BUILD_TOOLS_VERSION}/release/vs_community.exe")
dk_set(VISUAL_CPP_BUILD_TOOLS_DL 		"https://aka.ms/vs/17/release/vs_BuildTools.exe")
dk_assertPath(ProgramFiles)
dk_set(VISUAL_CPP_BUILD_TOOLS 			"C:/Program Files (x86)/Microsoft Visual Studio")
#dk_set(VISUAL_CPP_BUILD_TOOLS 			"$ENV{ProgramFiles (x86)}/Microsoft Visual Studio")
dk_printVar(VISUAL_CPP_BUILD_TOOLS)

# C:/Program Files (x86)/Microsoft Visual Studio/2022/BuildTools/VC/Tools/MSVC
macro(get_visualstudio_year result)
	file(GLOB children RELATIVE "${VISUAL_CPP_BUILD_TOOLS}" "${VISUAL_CPP_BUILD_TOOLS}/*")
	foreach(child ${children})
		if(IS_DIRECTORY "${VISUAL_CPP_BUILD_TOOLS}/${child}")
			if(EXISTS "${VISUAL_CPP_BUILD_TOOLS}/${child}/BuildTools")
				set(${result} ${child})
				dk_printVar(${result})
			endif()
		endif()
	endforeach()
	if(NOT ${result})
		dk_fatal("get_visualstudio_year() Could not locate year.")
	endif()
endmacro()

macro(get_visualstudio_edition result)
	file(GLOB children RELATIVE "${VISUAL_CPP_BUILD_TOOLS}/VC/Tools/MSVC" "${VISUAL_CPP_BUILD_TOOLS}/VC/Tools/MSVC/*")
	foreach(child ${children})
		if(IS_DIRECTORY "${VISUAL_CPP_BUILD_TOOLS}/VC/Tools/MSVC/${child}")
			if(EXISTS "${VISUAL_CPP_BUILD_TOOLS}/VC/Tools/MSVC/${child}/bin/Hostx86")
				set(${result} ${child})
				dk_printVar(${result})
			endif()
		endif()
	endforeach()
	if(NOT ${result})
		dk_fatal("get_visualstudio_edition() Could not locate edition.")
	endif()
endmacro()

###### INSTALL Visual Studio ######	
if(NOT EXISTS ${VISUAL_CPP_BUILD_TOOLS})
	dk_info("Installing Visual Studio . . .")
	if(EXISTS ${DKDOWNLOAD_DIR}/VisualStudio/vs_setup.exe)
		dk_validate(DK3RDPARTY_DIR "dk_DK3RDPARTY_DIR()")
		dk_command(${DK3RDPARTY_DIR}/_DKIMPORTS/visualstudio/InstallVisualStudio.cmd)	# offline installer
	else()
		dk_download(${VISUAL_CPP_BUILD_TOOLS_DL} ${DKDOWNLOAD_DIR}/vs_BuildTools.exe)				# online installer
		dk_command(${DKDOWNLOAD_DIR}/vs_BuildTools.exe)
	endif()
else()
	dk_info("Visual Studio ${VISUAL_CPP_BUILD_TOOLS_VERSION} ${VISUAL_CPP_BUILD_TOOLS_YEAR} already installed")
endif()

###### set VISUAL_CPP_BUILD_TOOLS variables ######
get_visualstudio_year(VISUAL_CPP_BUILD_TOOLS_YEAR)
dk_set(VISUAL_CPP_BUILD_TOOLS 							"${VISUAL_CPP_BUILD_TOOLS}/${VISUAL_CPP_BUILD_TOOLS_YEAR}/BuildTools")
get_visualstudio_edition(VISUAL_CPP_BUILD_TOOLS_EDITION)
dk_set(VISUAL_CPP_BUILD_TOOLS_GENERATOR 				"Visual Studio ${VISUAL_CPP_BUILD_TOOLS_VERSION} ${VISUAL_CPP_BUILD_TOOLS_YEAR}")
dk_set(VISUAL_CPP_BUILD_TOOLS_MAKE_PROGRAM				"${VISUAL_CPP_BUILD_TOOLS}/MSBuild/Current/Bin/amd64/MSBuild.exe")
dk_set(VISUAL_CPP_BUILD_TOOLS_X86_COMPILER 				"${VISUAL_CPP_BUILD_TOOLS}/VC/Tools/MSVC/${VISUAL_CPP_BUILD_TOOLS_EDITION}/bin/Hostx64/x86/cl.exe")
dk_set(VISUAL_CPP_BUILD_TOOLS_X64_COMPILER 				"${VISUAL_CPP_BUILD_TOOLS}/VC/Tools/MSVC/${VISUAL_CPP_BUILD_TOOLS_EDITION}/bin/Hostx64/x64/cl.exe")
dk_set(VISUAL_CPP_BUILD_TOOLS_X86_LINKER 				"${VISUAL_CPP_BUILD_TOOLS}/VC/Tools/MSVC/${VISUAL_CPP_BUILD_TOOLS_EDITION}/bin/Hostx64/x86/link.exe")
dk_set(VISUAL_CPP_BUILD_TOOLS_X64_LINKER 				"${VISUAL_CPP_BUILD_TOOLS}/VC/Tools/MSVC/${VISUAL_CPP_BUILD_TOOLS_EDITION}/bin/Hostx64/x64/link.exe")
dk_set(VISUAL_CPP_BUILD_TOOLS_X86_DUMPBIN 				"${VISUAL_CPP_BUILD_TOOLS}/VC/Tools/MSVC/${VISUAL_CPP_BUILD_TOOLS_EDITION}/bin/Hostx86/x86/dumpbin.exe")
dk_set(VISUAL_CPP_BUILD_TOOLS_X64_DUMPBIN 				"${VISUAL_CPP_BUILD_TOOLS}/VC/Tools/MSVC/${VISUAL_CPP_BUILD_TOOLS_EDITION}/bin/Hostx86/x64/dumpbin.exe")
if(ARM64)
	dk_set(VISUAL_CPP_BUILD_TOOLS_GENERATOR_PLATFORM	ARM64)
elseif(X86)
	dk_set(VISUAL_CPP_BUILD_TOOLS_GENERATOR_PLATFORM	Win32)
	dk_set(VISUAL_CPP_BUILD_TOOLS_C_COMPILER			"${VISUAL_CPP_BUILD_TOOLS_X86_COMPILER}")
	dk_set(VISUAL_CPP_BUILD_TOOLS_CXX_COMPILER			"${VISUAL_CPP_BUILD_TOOLS_X86_COMPILER}")
	dk_set(VISUAL_CPP_BUILD_TOOLS_LINKER				"${VISUAL_CPP_BUILD_TOOLS_X86_LINKER}")
	dk_set(VISUAL_CPP_BUILD_TOOLS_DUMPBIN				"${VISUAL_CPP_BUILD_TOOLS_X86_DUMPBIN}")
elseif(X86_64)
	dk_set(VISUAL_CPP_BUILD_TOOLS_GENERATOR_PLATFORM	x64)
	dk_set(VISUAL_CPP_BUILD_TOOLS_C_COMPILER			"${VISUAL_CPP_BUILD_TOOLS_X64_COMPILER}")
	dk_set(VISUAL_CPP_BUILD_TOOLS_CXX_COMPILER			"${VISUAL_CPP_BUILD_TOOLS_X64_COMPILER}")
	dk_set(VISUAL_CPP_BUILD_TOOLS_LINKER				"${VISUAL_CPP_BUILD_TOOLS_X64_LINKER}")
	dk_set(VISUAL_CPP_BUILD_TOOLS_DUMPBIN				"${VISUAL_CPP_BUILD_TOOLS_X64_DUMPBIN}")
else()
	dk_fatal("Could not determin TARGET_ARCH to set VISUAL_CPP_BUILD_TOOLS variables")
endif()

###### Patch Android Files ######
if(ANDROID)	
	if(EXISTS "${VISUAL_CPP_BUILD_TOOLS}/MSBuild/Microsoft/MDD/Android/V150/Android.Common.targets")
		dk_info("Patching Android.Common.targets. . .")
		dk_fileReplace("${VISUAL_CPP_BUILD_TOOLS}/MSBuild/Microsoft/MDD/Android/V150/Android.Common.targets" ">ARM7</GradlePlatform>" "></GradlePlatform>")
		dk_fileReplace("${VISUAL_CPP_BUILD_TOOLS}/MSBuild/Microsoft/MDD/Android/V150/Android.Common.targets" ">ARM8</GradlePlatform>" "></GradlePlatform>")
		dk_fileReplace("${VISUAL_CPP_BUILD_TOOLS}/MSBuild/Microsoft/MDD/Android/V150/Android.Common.targets" ">x86-64</GradlePlatform>" "></GradlePlatform>")
	else()
		dk_fatal("${VISUAL_CPP_BUILD_TOOLS}/MSBuild/Microsoft/MDD/Android/V150/Android.Common.targets does not exist!")
	endif()
endif()

###### set GLOBAL CMAKE VARIABLES ######
if(NOT MSVC)
	dk_return()
endif()
dk_set(CMAKE_C_COMPILER				${VISUAL_CPP_BUILD_TOOLS_C_COMPILER})
dk_set(CMAKE_CXX_COMPILER			${VISUAL_CPP_BUILD_TOOLS_CXX_COMPILER})
dk_set(CMAKE_DUMPBIN				${VISUAL_CPP_BUILD_TOOLS_DUMPBIN})
dk_set(CMAKE_GENERATOR				${VISUAL_CPP_BUILD_TOOLS_GENERATOR})
dk_set(CMAKE_GENERATOR_PLATFORM		${VISUAL_CPP_BUILD_TOOLS_GENERATOR_PLATFORM})
dk_set(CMAKE_LINKER					${VISUAL_CPP_BUILD_TOOLS_LINKER})
dk_set(CMAKE_MAKE_PROGRAM 			${VISUAL_CPP_BUILD_TOOLS_MAKE_PROGRAM})
