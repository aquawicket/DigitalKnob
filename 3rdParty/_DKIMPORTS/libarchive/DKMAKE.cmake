# https://github.com/libarchive/libarchive
#
#
# INSTALL TARGETS given no BUNDLE DESTINATION for MACOSX_BUNDLE executabletarget "bsdcat".
# https://github.com/libarchive/libarchive/issues/1563


### DEPENDS ###
DKDEPEND(zlib)
DKDEPEND(xz)
DKDEPEND(bzip2)
DKDEPEND(libxml2)
DKDEPEND(libiconv)
DKDEPEND(cryptopp)
WIN_DKDEPEND(openssl)


#DKIMPORT(https://github.com/libarchive/libarchive)
DKIMPORT(https://github.com/libarchive/libarchive/archive/93f03b0f5d7316714df9b289a49150ab7a63bfaf.zip)

#DKSET(LIBARCHIVE_VERSION 3.6.0)
#DKSET(LIBARCHIVE_DL https://github.com/libarchive/libarchive/releases/download/v3.6.0/libarchive-3.6.0.zip)
#DKSET(LIBARCHIVE_NAME libarchive-${LIBARCHIVE_VERSION})
#DKSET(LIBARCHIVE ${3RDPARTY}/${LIBARCHIVE_NAME})
#DKINSTALL(${LIBARCHIVE_DL} libarchive ${LIBARCHIVE}) #NOPATCH


### DKPLUGINS LINK ###
DKDEFINE(LIBARCHIVE_STATIC)
DKINCLUDE(${LIBARCHIVE}/libarchive)
DKINCLUDE(${LIBARCHIVE}/${OS})
ANDROID_DKINCLUDE(${LIBARCHIVE}/contrib/android/include)
WIN_DEBUG_DKLIB(${LIBARCHIVE}/${OS}/libarchive/${DEBUG_DIR}/archive_static.lib)
WIN_RELEASE_DKLIB(${LIBARCHIVE}/${OS}/libarchive/${RELEASE_DIR}/archive_static.lib)
APPLE_DEBUG_DKLIB(${LIBARCHIVE}/${OS}/libarchive/${DEBUG_DIR}/libarchive.a)
APPLE_RELEASE_DKLIB(${LIBARCHIVE}/${OS}/libarchive/${RELEASE_DIR}/libarchive.a)
LINUX_DEBUG_DKLIB(${LIBARCHIVE}/${OS}/${DEBUG_DIR}/libarchive/libarchive.a)
LINUX_RELEASE_DKLIB(${LIBARCHIVE}/${OS}/${RELEASE_DIR}/libarchive/libarchive.a)
RASPBERRY_DEBUG_DKLIB(${LIBARCHIVE}/${OS}/${DEBUG_DIR}/libarchive/libarchive.a)
RASPBERRY_RELEASE_DKLIB(${LIBARCHIVE}/${OS}/${RELEASE_DIR}/libarchive/libarchive.a)
ANDROID_DEBUG_DKLIB(${LIBARCHIVE}/${OS}/libarchive/${DEBUG_DIR}/libarchive.a)
ANDROID_RELEASE_DKLIB(${LIBARCHIVE}/${OS}/libarchive/${RELEASE_DIR}/libarchive.a)



### COMPILE ###
DKSETPATH(${LIBARCHIVE}/${BUILD_DIR})

#dk_removeSubstring("-std=c17" "${DKCMAKE_BUILD}" DKCMAKE_BUILD_ARCHIVE)
#dk_removeSubstring("-std=c++1z" "${DKCMAKE_BUILD}" DKCMAKE_BUILD_ARCHIVE)
WIN_DKQCOMMAND(${DKCMAKE_BUILD}	
	-DWINDOWS_VERSION=WIN10
	-DENABLE_BZip2=ON
	-DUSE_BZIP2_STATIC=ON
	-DUSE_BZIP2_DLL=OFF 
	-DBUILD_TESTING=OFF 
	-DENABLE_TEST=OFF 
	-DENABLE_ACL=OFF 
	-DENABLE_CPIO=OFF 
	-DENABLE_CNG=OFF
	-DENABLE_ICONV=OFF
	-DENABLE_NETTLE=OFF 
	#-DENABLE_OPENSSL=OFF
	-DENABLE_TAR=ON 
	-DENABLE_XATTR=OFF
	#-DENABLE_LIBXML2=OFF 
	#-DLIBXML2_INCLUDE_DIR=OFF 
	#-DLIBXML2_LIBRARIES=OFF 
	#-DLIBXML2_XMLLINT_EXECUTABLE=OFF 
	-DENABLE_EXPAT=OFF 
	-DEXPAT_INCLUDE_DIR=OFF 
	-DEXPAT_LIBRARY=OFF
	#-DICONV_INCLUDE_DIR=OFF 
	-DENABLE_LibGCC=OFF 
	-DENABLE_LIBB2=OFF 
	-DENABLE_LZ4=OFF 
	-DENABLE_PCREPOSIX=OFF 
	-DENABLE_ZSTD=OFF 
	-DENABLE_WERROR=OFF
	${XZ_CMAKE} 
	${BZIP2_CMAKE}
	${ZLIB_CMAKE} 
	${XML2_CMAKE}
	${ICONV_CMAKE}
	${OPENSSL_CMAKE}
	${LIBARCHIVE})
WIN_VS(${LIBARCHIVE_NAME} libarchive.sln archive_static)

#dk_removeSubstring("-std=c++17" "${DKCMAKE_BUILD}" DKCMAKE_BUILD_ARCHIVE)
MAC_DKQCOMMAND(${DKCMAKE_BUILD} -DENABLE_BZip2=OFF -DBUILD_TESTING=OFF -DENABLE_TEST=OFF -DENABLE_ACL=OFF -DENABLE_CPIO=OFF -DENABLE_CNG=OFF -DENABLE_ICONV=OFF -DENABLE_NETTLE=OFF -DENABLE_OPENSSL=OFF -DENABLE_TAR=ON -DENABLE_XATTR=OFF -DLIBXML2_INCLUDE_DIR=OFF -DLIBXML2_LIBRARIES=OFF -DLIBXML2_XMLLINT_EXECUTABLE=OFF -DLZO2_INCLUDE_DIR=OFF -DLZO2_LIBRARY=OFF -DEXPAT_INCLUDE_DIR=OFF -DEXPAT_LIBRARY=OFF -DICONV_INCLUDE_DIR=OFF -DENABLE_ZSTD=OFF ${XZ_CMAKE} ${BZIP2_CMAKE} ${ZLIB_CMAKE} ${LIBARCHIVE})
MAC_XCODE(${LIBARCHIVE_NAME} archive_static)


IOS_DKQCOMMAND(${DKCMAKE_BUILD} "-DCMAKE_C_FLAGS=-I${LIBARCHIVE}/libarchive" -DENABLE_BZip2=OFF -DBUILD_TESTING=OFF -DENABLE_TEST=OFF -DENABLE_ACL=OFF -DENABLE_CPIO=OFF -DENABLE_CNG=OFF -DENABLE_ICONV=OFF -DENABLE_NETTLE=OFF -DENABLE_OPENSSL=OFF -DENABLE_TAR=ON -DENABLE_XATTR=OFF -DLIBXML2_INCLUDE_DIR=OFF -DLIBXML2_LIBRARIES=OFF -DLIBXML2_XMLLINT_EXECUTABLE=OFF -DLZO2_INCLUDE_DIR=OFF -DLZO2_LIBRARY=OFF -DEXPAT_INCLUDE_DIR=OFF -DEXPAT_LIBRARY=OFF -DICONV_INCLUDE_DIR=OFF ${XZ_CMAKE} ${BZIP2_CMAKE} ${ZLIB_CMAKE} ${LIBARCHIVE})
IOS_XCODE(${LIBARCHIVE_NAME} archive_static)


IOSSIM_DKQCOMMAND(${DKCMAKE_BUILD} "-DCMAKE_C_FLAGS=-I${LIBARCHIVE}/libarchive" -DIOS=TRUE -DENABLE_BZip2=OFF -DBUILD_TESTING=OFF -DENABLE_TEST=OFF -DENABLE_ACL=OFF -DENABLE_CPIO=OFF -DENABLE_CNG=OFF -DENABLE_ICONV=OFF -DENABLE_NETTLE=OFF -DENABLE_OPENSSL=OFF -DENABLE_TAR=OFF -DENABLE_XATTR=OFF -DLIBXML2_INCLUDE_DIR=OFF -DLIBXML2_LIBRARIES=OFF -DLIBXML2_XMLLINT_EXECUTABLE=OFF -DLZO2_INCLUDE_DIR=OFF -DLZO2_LIBRARY=OFF -DEXPAT_INCLUDE_DIR=OFF -DEXPAT_LIBRARY=OFF -DICONV_INCLUDE_DIR=OFF -DENABLE_CAT=OFF ${XZ_CMAKE} ${BZIP2_CMAKE} ${ZLIB_CMAKE} ${LIBARCHIVE})
if(IOSSIM)
	file(APPEND ${LIBARCHIVE}/${OS}/config.h "#include <time.h>\n")
	file(APPEND ${LIBARCHIVE}/${OS}/config.h "typedef int errno_t;\n")
	file(APPEND ${LIBARCHIVE}/${OS}/config.h "typedef time_t __time64_t;\n")
	file(APPEND ${LIBARCHIVE}/${OS}/config.h "#undef HAVE__GMTIME64_S\n")
	file(APPEND ${LIBARCHIVE}/${OS}/config.h "#undef HAVE__CTIME64_S\n")
	file(APPEND ${LIBARCHIVE}/${OS}/config.h "#undef HAVE_FUTIMESAT\n")
endif()
IOSSIM_XCODE(${LIBARCHIVE_NAME} archive_static)


LINUX_DKQCOMMAND(${DKCMAKE_BUILD} -DENABLE_TEST=OFF -DENABLE_ACL=OFF -DENABLE_CPIO=OFF -DENABLE_CNG=OFF -DENABLE_ICONV=OFF -DENABLE_NETTLE=OFF -DENABLE_OPENSSL=OFF -DENABLE_TAR=ON -DENABLE_XATTR=OFF -DLIBXML2_INCLUDE_DIR=OFF -DLIBXML2_LIBRARIES=OFF -DLIBXML2_XMLLINT_EXECUTABLE=OFF -DEXPAT_INCLUDE_DIR=OFF -DEXPAT_LIBRARY=OFF -DICONV_INCLUDE_DIR=OFF ${XZ_CMAKE} ${BZIP2_CMAKE} ${ZLIB_CMAKE} ${LIBARCHIVE})
LINUX_DKQCOMMAND(make archive_static)


RASPBERRY_DKQCOMMAND(${DKCMAKE_BUILD} -DENABLE_TEST=OFF -DENABLE_ACL=OFF -DENABLE_CPIO=OFF -DENABLE_CNG=OFF -DENABLE_ICONV=OFF -DENABLE_NETTLE=OFF -DENABLE_OPENSSL=OFF -DENABLE_TAR=ON -DENABLE_XATTR=OFF -DLIBXML2_INCLUDE_DIR=OFF -DLIBXML2_LIBRARIES=OFF -DLIBXML2_XMLLINT_EXECUTABLE=OFF -DEXPAT_INCLUDE_DIR=OFF -DEXPAT_LIBRARY=OFF -DICONV_INCLUDE_DIR=OFF ${XZ_CMAKE} ${BZIP2_CMAKE} ${ZLIB_CMAKE} ${LIBARCHIVE})
RASPBERRY_DKQCOMMAND(make archive_static)


ANDROID_DKQCOMMAND(${DKCMAKE_BUILD} "-DCMAKE_C_FLAGS=-I${LIBARCHIVE}/${OS} -I${LIBARCHIVE}/contrib/android/include -I${ZLIB}/${OS}" -DENABLE_BZip2=OFF -DUSE_BZIP2_DLL=OFF -DBUILD_TESTING=OFF -DENABLE_TEST=OFF -DENABLE_ACL=OFF -DENABLE_CPIO=OFF -DENABLE_CNG=OFF -DENABLE_EXPAT=OFF -DENABLE_ICONV=OFF -DENABLE_LIBXML2=OFF -DENABLE_NETTLE=OFF -DENABLE_OPENSSL=OFF -DENABLE_TAR=OFF -DENABLE_XATTR=OFF -DLIBXML2_INCLUDE_DIR=OFF -DLIBXML2_LIBRARIES=OFF -DLIBXML2_XMLLINT_EXECUTABLE=OFF -DEXPAT_INCLUDE_DIR=OFF -DEXPAT_LIBRARY=OFF -DICONV_INCLUDE_DIR=OFF -DENABLE_LibGCC=OFF -DENABLE_LIBB2=OFF -DENABLE_CAT=OFF -DENABLE_LZ4=OFF -DENABLE_PCREPOSIX=OFF -DENABLE_ZSTD=OFF ${XZ_CMAKE} ${BZIP2_CMAKE} ${ZLIB_CMAKE} ${LIBARCHIVE})
ANDROID_VS(${LIBARCHIVE_NAME} libarchive.sln archive_static)
