# https://github.com/libarchive/libarchive
#
# INSTALL TARGETS given no BUNDLE DESTINATION for MACOSX_BUNDLE executabletarget "bsdcat".
# https://github.com/libarchive/libarchive/issues/1563


### DEPENDS ###
dk_depend(zlib)
dk_depend(xz)
dk_depend(bzip2)
dk_depend(libxml2)
dk_depend(libiconv)
dk_depend(cryptopp)
WIN_dk_depend(openssl)


dk_import(https://github.com/libarchive/libarchive/archive/93f03b0f5d7316714df9b289a49150ab7a63bfaf.zip PATCH)
#dk_import(https://github.com/libarchive/libarchive.git 93f03b0f5d7316714df9b289a49150ab7a63bfaf PATCH)


### LINK ###
dk_define(LIBARCHIVE_STATIC)
dk_include(${LIBARCHIVE}/libarchive)
dk_include(${LIBARCHIVE}/${OS})
ANDROID_dk_include(${LIBARCHIVE}/contrib/android/include)
WIN_dk_libDebug			(${LIBARCHIVE}/${OS}/libarchive/${DEBUG_DIR}/archive_static.lib)
WIN_dk_libRelease		(${LIBARCHIVE}/${OS}/libarchive/${RELEASE_DIR}/archive_static.lib)
APPLE_dk_libDebug		(${LIBARCHIVE}/${OS}/libarchive/${DEBUG_DIR}/libarchive.a)
APPLE_dk_libRelease		(${LIBARCHIVE}/${OS}/libarchive/${RELEASE_DIR}/libarchive.a)
LINUX_dk_libDebug		(${LIBARCHIVE}/${OS}/${DEBUG_DIR}/libarchive/libarchive.a)
LINUX_dk_libRelease		(${LIBARCHIVE}/${OS}/${RELEASE_DIR}/libarchive/libarchive.a)
RASPBERRY_dk_libDebug	(${LIBARCHIVE}/${OS}/${DEBUG_DIR}/libarchive/libarchive.a)
RASPBERRY_dk_libRelease	(${LIBARCHIVE}/${OS}/${RELEASE_DIR}/libarchive/libarchive.a)
ANDROID_dk_libDebug		(${LIBARCHIVE}/${OS}/libarchive/${DEBUG_DIR}/libarchive.a)
ANDROID_dk_libRelease	(${LIBARCHIVE}/${OS}/libarchive/${RELEASE_DIR}/libarchive.a)


### GENERATE ###
dk_setPath(${LIBARCHIVE}/${BUILD_DIR})
#dk_removeSubstring("-std=c17" "${DKCMAKE_BUILD}" DKCMAKE_BUILD_ARCHIVE)
#dk_removeSubstring("-std=c++1z" "${DKCMAKE_BUILD}" DKCMAKE_BUILD_ARCHIVE)
WIN_dk_queueCommand(${DKCMAKE_BUILD}	
	-DWINDOWS_VERSION=WIN10
	-DENABLE_BZip2=ON
	-DUSE_BZIP2_STATIC=ON
	-DUSE_BZIP2_DLL=OFF 
	-DBUILD_TESTING=OFF 
	-DENABLE_TEST=OFF 
	-DENABLE_ACL=OFF 
	-DENABLE_CPIO=OFF 
	-DENABLE_CNG=OFF
	-DENABLE_ICONV=OFF
	-DENABLE_NETTLE=OFF 
	#-DENABLE_OPENSSL=OFF
	-DENABLE_TAR=ON 
	-DENABLE_XATTR=OFF
	#-DENABLE_LIBXML2=OFF 
	#-DLIBXML2_INCLUDE_DIR=OFF 
	#-DLIBXML2_LIBRARIES=OFF 
	#-DLIBXML2_XMLLINT_EXECUTABLE=OFF 
	-DENABLE_EXPAT=OFF 
	-DEXPAT_INCLUDE_DIR=OFF 
	-DEXPAT_LIBRARY=OFF
	#-DICONV_INCLUDE_DIR=OFF 
	-DENABLE_LibGCC=OFF 
	-DENABLE_LIBB2=OFF 
	-DENABLE_LZ4=OFF 
	-DENABLE_PCREPOSIX=OFF 
	-DENABLE_ZSTD=OFF 
	-DENABLE_WERROR=OFF
	${XZ_CMAKE} 
	${BZIP2_CMAKE}
	${ZLIB_CMAKE} 
	${XML2_CMAKE}
	${ICONV_CMAKE}
	${OPENSSL_CMAKE}
	${LIBARCHIVE})
#dk_removeSubstring("-std=c++17" "${DKCMAKE_BUILD}" DKCMAKE_BUILD_ARCHIVE)
MAC_dk_queueCommand(${DKCMAKE_BUILD} -DENABLE_BZip2=OFF -DBUILD_TESTING=OFF -DENABLE_TEST=OFF -DENABLE_ACL=OFF -DENABLE_CPIO=OFF -DENABLE_CNG=OFF -DENABLE_ICONV=OFF -DENABLE_NETTLE=OFF -DENABLE_OPENSSL=OFF -DENABLE_TAR=ON -DENABLE_XATTR=OFF -DLIBXML2_INCLUDE_DIR=OFF -DLIBXML2_LIBRARIES=OFF -DLIBXML2_XMLLINT_EXECUTABLE=OFF -DLZO2_INCLUDE_DIR=OFF -DLZO2_LIBRARY=OFF -DEXPAT_INCLUDE_DIR=OFF -DEXPAT_LIBRARY=OFF -DICONV_INCLUDE_DIR=OFF -DENABLE_ZSTD=OFF ${XZ_CMAKE} ${BZIP2_CMAKE} ${ZLIB_CMAKE} ${LIBARCHIVE})
IOS_dk_queueCommand(${DKCMAKE_BUILD} "-DCMAKE_C_FLAGS=-I${LIBARCHIVE}/libarchive" -DENABLE_WERROR=0 -DIOS=TRUE -DENABLE_BZip2=OFF -DBUILD_TESTING=OFF -DENABLE_TEST=OFF -DENABLE_ACL=OFF -DENABLE_CPIO=OFF -DENABLE_CNG=OFF -DENABLE_ICONV=OFF -DENABLE_NETTLE=OFF -DENABLE_OPENSSL=OFF -DENABLE_TAR=OFF -DENABLE_XATTR=OFF -DLIBXML2_INCLUDE_DIR=OFF -DLIBXML2_LIBRARIES=OFF -DLIBXML2_XMLLINT_EXECUTABLE=OFF -DLZO2_INCLUDE_DIR=OFF -DLZO2_LIBRARY=OFF -DEXPAT_INCLUDE_DIR=OFF -DEXPAT_LIBRARY=OFF -DICONV_INCLUDE_DIR=OFF -DENABLE_CAT=OFF ${XZ_CMAKE} ${BZIP2_CMAKE} ${ZLIB_CMAKE} ${LIBARCHIVE})
if(IOS)
	file(APPEND ${LIBARCHIVE}/${OS}/config.h "#include <time.h>\n")
	file(APPEND ${LIBARCHIVE}/${OS}/config.h "typedef int errno_t;\n")
	file(APPEND ${LIBARCHIVE}/${OS}/config.h "typedef time_t __time64_t;\n")
	file(APPEND ${LIBARCHIVE}/${OS}/config.h "#undef HAVE__GMTIME64_S\n")
	file(APPEND ${LIBARCHIVE}/${OS}/config.h "#undef HAVE__CTIME64_S\n")
	file(APPEND ${LIBARCHIVE}/${OS}/config.h "#undef HAVE_FUTIMESAT\n")
endif()
IOSSIM_dk_queueCommand(${DKCMAKE_BUILD} "-DCMAKE_C_FLAGS=-I${LIBARCHIVE}/libarchive" -DENABLE_WERROR=0 -DIOS=TRUE -DENABLE_BZip2=OFF -DBUILD_TESTING=OFF -DENABLE_TEST=OFF -DENABLE_ACL=OFF -DENABLE_CPIO=OFF -DENABLE_CNG=OFF -DENABLE_ICONV=OFF -DENABLE_NETTLE=OFF -DENABLE_OPENSSL=OFF -DENABLE_TAR=OFF -DENABLE_XATTR=OFF -DLIBXML2_INCLUDE_DIR=OFF -DLIBXML2_LIBRARIES=OFF -DLIBXML2_XMLLINT_EXECUTABLE=OFF -DLZO2_INCLUDE_DIR=OFF -DLZO2_LIBRARY=OFF -DEXPAT_INCLUDE_DIR=OFF -DEXPAT_LIBRARY=OFF -DICONV_INCLUDE_DIR=OFF -DENABLE_CAT=OFF -DCMAKE_SYSTEM_NAME=iOS -DCMAKE_OSX_SYSROOT=iphonesimulator -DCMAKE_OSX_ARCHITECTURES=x86_64 ${XZ_CMAKE} ${BZIP2_CMAKE} ${ZLIB_CMAKE} ${LIBARCHIVE})
if(IOSSIM)
	file(APPEND ${LIBARCHIVE}/${OS}/config.h "#include <time.h>\n")
	file(APPEND ${LIBARCHIVE}/${OS}/config.h "typedef int errno_t;\n")
	file(APPEND ${LIBARCHIVE}/${OS}/config.h "typedef time_t __time64_t;\n")
	file(APPEND ${LIBARCHIVE}/${OS}/config.h "#undef HAVE__GMTIME64_S\n")
	file(APPEND ${LIBARCHIVE}/${OS}/config.h "#undef HAVE__CTIME64_S\n")
	file(APPEND ${LIBARCHIVE}/${OS}/config.h "#undef HAVE_FUTIMESAT\n")
endif()
LINUX_dk_queueCommand(${DKCMAKE_BUILD} -DENABLE_TEST=OFF -DENABLE_ACL=OFF -DENABLE_CPIO=OFF -DENABLE_CNG=OFF -DENABLE_ICONV=OFF -DENABLE_NETTLE=OFF -DENABLE_OPENSSL=OFF -DENABLE_TAR=ON -DENABLE_XATTR=OFF -DLIBXML2_INCLUDE_DIR=OFF -DLIBXML2_LIBRARIES=OFF -DLIBXML2_XMLLINT_EXECUTABLE=OFF -DEXPAT_INCLUDE_DIR=OFF -DEXPAT_LIBRARY=OFF -DICONV_INCLUDE_DIR=OFF ${XZ_CMAKE} ${BZIP2_CMAKE} ${ZLIB_CMAKE} ${LIBARCHIVE})
RASPBERRY_dk_queueCommand(${DKCMAKE_BUILD} -DENABLE_TEST=OFF -DENABLE_ACL=OFF -DENABLE_CPIO=OFF -DENABLE_CNG=OFF -DENABLE_ICONV=OFF -DENABLE_NETTLE=OFF -DENABLE_OPENSSL=OFF -DENABLE_TAR=ON -DENABLE_XATTR=OFF -DLIBXML2_INCLUDE_DIR=OFF -DLIBXML2_LIBRARIES=OFF -DLIBXML2_XMLLINT_EXECUTABLE=OFF -DEXPAT_INCLUDE_DIR=OFF -DEXPAT_LIBRARY=OFF -DICONV_INCLUDE_DIR=OFF ${XZ_CMAKE} ${BZIP2_CMAKE} ${ZLIB_CMAKE} ${LIBARCHIVE})
ANDROID_dk_queueCommand(${DKCMAKE_BUILD} "-DCMAKE_C_FLAGS=-I${LIBARCHIVE}/${OS} -I${LIBARCHIVE}/contrib/android/include -I${ZLIB}/${OS}" -DENABLE_BZip2=OFF -DUSE_BZIP2_DLL=OFF -DBUILD_TESTING=OFF -DENABLE_TEST=OFF -DENABLE_ACL=OFF -DENABLE_CPIO=OFF -DENABLE_CNG=OFF -DENABLE_EXPAT=OFF -DENABLE_ICONV=OFF -DENABLE_LIBXML2=OFF -DENABLE_NETTLE=OFF -DENABLE_OPENSSL=OFF -DENABLE_TAR=OFF -DENABLE_XATTR=OFF -DLIBXML2_INCLUDE_DIR=OFF -DLIBXML2_LIBRARIES=OFF -DLIBXML2_XMLLINT_EXECUTABLE=OFF -DEXPAT_INCLUDE_DIR=OFF -DEXPAT_LIBRARY=OFF -DICONV_INCLUDE_DIR=OFF -DENABLE_LibGCC=OFF -DENABLE_LIBB2=OFF -DENABLE_CAT=OFF -DENABLE_LZ4=OFF -DENABLE_PCREPOSIX=OFF -DENABLE_ZSTD=OFF ${XZ_CMAKE} ${BZIP2_CMAKE} ${ZLIB_CMAKE} ${LIBARCHIVE})


### COMPILE ###
dk_visualStudio	(${LIBARCHIVE_NAME} archive_static)
dk_xcode		(${LIBARCHIVE_NAME} archive_static)
dk_make			(${LIBARCHIVE_NAME} archive_static)
