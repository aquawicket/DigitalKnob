# Information
# https://www.libarchive.org/
#
# Downloads
# https://github.com/libarchive/libarchive/archive/refs/tags/v3.5.1.zip
#
# INSTALL TARGETS given no BUNDLE DESTINATION for MACOSX_BUNDLE executabletarget "bsdcat".
# https://github.com/libarchive/libarchive/issues/1563


### DEPENDS ###
DKDEPEND(zlib)
DKDEPEND(xz)
DKDEPEND(bzip2)
DKDEPEND(libxml2)
DKDEPEND(libiconv)
DKDEPEND(cryptopp)
WIN_DKDEPEND(openssl)


### VERSION ###
DKSET(ARCHIVE_VERSION 3.5.1)
DKSET(ARCHIVE_NAME libarchive-${ARCHIVE_VERSION})
DKSET(ARCHIVE_DL https://github.com/libarchive/libarchive/archive/refs/tags/v${ARCHIVE_VERSION}.zip)
DKSET(ARCHIVE ${3RDPARTY}/${ARCHIVE_NAME})


### INSTALL ###
DKINSTALL(${ARCHIVE_DL} libarchive ${ARCHIVE}) #NOPATCH


### DKPLUGINS LINK ###
DKDEFINE(LIBARCHIVE_STATIC)
DKINCLUDE(${ARCHIVE}/libarchive)
DKINCLUDE(${ARCHIVE}/${OS})
ANDROID_DKINCLUDE(${ARCHIVE}/contrib/android/include)
WIN_DEBUG_DKLIB(${ARCHIVE}/${OS}/libarchive/${DEBUG_DIR}/archive_static.lib)
WIN_RELEASE_DKLIB(${ARCHIVE}/${OS}/libarchive/${RELEASE_DIR}/archive_static.lib)
APPLE_DEBUG_DKLIB(${ARCHIVE}/${OS}/libarchive/${DEBUG_DIR}/libarchive.a)
APPLE_RELEASE_DKLIB(${ARCHIVE}/${OS}/libarchive/${RELEASE_DIR}/libarchive.a)
LINUX_DEBUG_DKLIB(${ARCHIVE}/${OS}/${DEBUG_DIR}/libarchive/libarchive.a)
LINUX_RELEASE_DKLIB(${ARCHIVE}/${OS}/${RELEASE_DIR}/libarchive/libarchive.a)
RASPBERRY_DEBUG_DKLIB(${ARCHIVE}/${OS}/${DEBUG_DIR}/libarchive/libarchive.a)
RASPBERRY_RELEASE_DKLIB(${ARCHIVE}/${OS}/${RELEASE_DIR}/libarchive/libarchive.a)
ANDROID_DEBUG_DKLIB(${ARCHIVE}/${OS}/libarchive/${DEBUG_DIR}/libarchive.a)
ANDROID_RELEASE_DKLIB(${ARCHIVE}/${OS}/libarchive/${RELEASE_DIR}/libarchive.a)



### COMPILE ###
DKSETPATH(${ARCHIVE}/${BUILD_DIR})

WIN32_DKQCOMMAND(${DKCMAKE_BUILD} 
	-DWINDOWS_VERSION=WIN10
	-DENABLE_BZip2=ON 
	-DUSE_BZIP2_STATIC=ON
	-DUSE_BZIP2_DLL=OFF 
	-DBUILD_TESTING=OFF 
	-DENABLE_TEST=OFF 
	-DENABLE_ACL=OFF 
	-DENABLE_CPIO=OFF 
	-DENABLE_CNG=OFF 
	-DENABLE_EXPAT=OFF 
	-DENABLE_ICONV=OFF
	-DENABLE_NETTLE=OFF 
	-DENABLE_OPENSSL=OFF 
	-DENABLE_TAR=ON 
	-DENABLE_XATTR=OFF
	#-DENABLE_LIBXML2=OFF 
	#-DLIBXML2_INCLUDE_DIR=OFF 
	#-DLIBXML2_LIBRARIES=OFF 
	#-DLIBXML2_XMLLINT_EXECUTABLE=OFF 
	-DEXPAT_INCLUDE_DIR=OFF 
	-DEXPAT_LIBRARY=OFF 
	#-DICONV_INCLUDE_DIR=OFF 
	-DENABLE_LibGCC=OFF 
	-DENABLE_LIBB2=OFF 
	-DENABLE_LZ4=OFF 
	-DENABLE_PCREPOSIX=OFF 
	-DENABLE_ZSTD=OFF 
	${XZ_CMAKE} 
	${BZIP2_CMAKE}
	${ZLIB_CMAKE}
	${XML2_CMAKE}
	${ICONV_CMAKE}
	${OPENSSL_CMAKE}
	${ARCHIVE})
WIN64_DKQCOMMAND(${DKCMAKE_BUILD}
	-DWINDOWS_VERSION=WIN10
	-DENABLE_BZip2=ON
	-DUSE_BZIP2_STATIC=ON
	-DUSE_BZIP2_DLL=OFF 
	-DBUILD_TESTING=OFF 
	-DENABLE_TEST=OFF 
	-DENABLE_ACL=OFF 
	-DENABLE_CPIO=OFF 
	-DENABLE_CNG=OFF
	-DENABLE_ICONV=OFF
	-DENABLE_NETTLE=OFF 
	-DENABLE_OPENSSL=OFF
	-DENABLE_TAR=ON 
	-DENABLE_XATTR=OFF
	#-DENABLE_LIBXML2=OFF 
	#-DLIBXML2_INCLUDE_DIR=OFF 
	#-DLIBXML2_LIBRARIES=OFF 
	#-DLIBXML2_XMLLINT_EXECUTABLE=OFF 
	-DENABLE_EXPAT=OFF 
	-DEXPAT_INCLUDE_DIR=OFF 
	-DEXPAT_LIBRARY=OFF
	#-DICONV_INCLUDE_DIR=OFF 
	-DENABLE_LibGCC=OFF 
	-DENABLE_LIBB2=OFF 
	-DENABLE_LZ4=OFF 
	-DENABLE_PCREPOSIX=OFF 
	-DENABLE_ZSTD=OFF 
	${XZ_CMAKE} 
	${BZIP2_CMAKE}
	${ZLIB_CMAKE} 
	${XML2_CMAKE}
	${ICONV_CMAKE}
	${OPENSSL_CMAKE}
	${ARCHIVE})
WIN_VS(${ARCHIVE_NAME} libarchive.sln archive_static)


MAC_DKQCOMMAND(${DKCMAKE_BUILD} -DENABLE_BZip2=OFF -DBUILD_TESTING=OFF -DENABLE_TEST=OFF -DENABLE_ACL=OFF -DENABLE_CPIO=OFF -DENABLE_CNG=OFF -DENABLE_ICONV=OFF -DENABLE_NETTLE=OFF -DENABLE_OPENSSL=OFF -DENABLE_TAR=ON -DENABLE_XATTR=OFF -DLIBXML2_INCLUDE_DIR=OFF -DLIBXML2_LIBRARIES=OFF -DLIBXML2_XMLLINT_EXECUTABLE=OFF -DLZO2_INCLUDE_DIR=OFF -DLZO2_LIBRARY=OFF -DEXPAT_INCLUDE_DIR=OFF -DEXPAT_LIBRARY=OFF -DICONV_INCLUDE_DIR=OFF ${XZ_CMAKE} ${BZIP2_CMAKE} ${ZLIB_CMAKE} ${ARCHIVE})
MAC_XCODE(${ARCHIVE_NAME} archive_static)


IOS_DKQCOMMAND(${DKCMAKE_BUILD} "-DCMAKE_C_FLAGS=-I${ARCHIVE}/libarchive" -DENABLE_BZip2=OFF -DBUILD_TESTING=OFF -DENABLE_TEST=OFF -DENABLE_ACL=OFF -DENABLE_CPIO=OFF -DENABLE_CNG=OFF -DENABLE_ICONV=OFF -DENABLE_NETTLE=OFF -DENABLE_OPENSSL=OFF -DENABLE_TAR=ON -DENABLE_XATTR=OFF -DLIBXML2_INCLUDE_DIR=OFF -DLIBXML2_LIBRARIES=OFF -DLIBXML2_XMLLINT_EXECUTABLE=OFF -DLZO2_INCLUDE_DIR=OFF -DLZO2_LIBRARY=OFF -DEXPAT_INCLUDE_DIR=OFF -DEXPAT_LIBRARY=OFF -DICONV_INCLUDE_DIR=OFF ${XZ_CMAKE} ${BZIP2_CMAKE} ${ZLIB_CMAKE} ${ARCHIVE})
IOS_XCODE(${ARCHIVE_NAME} archive_static)


IOSSIM_DKQCOMMAND(${DKCMAKE_BUILD} "-DCMAKE_C_FLAGS=-I${ARCHIVE}/libarchive" -DIOS=TRUE -DENABLE_BZip2=OFF -DBUILD_TESTING=OFF -DENABLE_TEST=OFF -DENABLE_ACL=OFF -DENABLE_CPIO=OFF -DENABLE_CNG=OFF -DENABLE_ICONV=OFF -DENABLE_NETTLE=OFF -DENABLE_OPENSSL=OFF -DENABLE_TAR=OFF -DENABLE_XATTR=OFF -DLIBXML2_INCLUDE_DIR=OFF -DLIBXML2_LIBRARIES=OFF -DLIBXML2_XMLLINT_EXECUTABLE=OFF -DLZO2_INCLUDE_DIR=OFF -DLZO2_LIBRARY=OFF -DEXPAT_INCLUDE_DIR=OFF -DEXPAT_LIBRARY=OFF -DICONV_INCLUDE_DIR=OFF -DENABLE_CAT=OFF ${XZ_CMAKE} ${BZIP2_CMAKE} ${ZLIB_CMAKE} ${ARCHIVE})
if(IOSSIM)
	file(APPEND ${ARCHIVE}/${OS}/config.h "#include <time.h>\n")
	file(APPEND ${ARCHIVE}/${OS}/config.h "typedef int errno_t;\n")
	file(APPEND ${ARCHIVE}/${OS}/config.h "typedef time_t __time64_t;\n")
	file(APPEND ${ARCHIVE}/${OS}/config.h "#undef HAVE__GMTIME64_S\n")
	file(APPEND ${ARCHIVE}/${OS}/config.h "#undef HAVE__CTIME64_S\n")
	file(APPEND ${ARCHIVE}/${OS}/config.h "#undef HAVE_FUTIMESAT\n")
endif()
IOSSIM_XCODE(${ARCHIVE_NAME} archive_static)

LINUX_DKQCOMMAND(${DKCMAKE_BUILD} -DENABLE_TEST=OFF -DENABLE_ACL=OFF -DENABLE_CPIO=OFF -DENABLE_CNG=OFF -DENABLE_ICONV=OFF -DENABLE_NETTLE=OFF -DENABLE_OPENSSL=OFF -DENABLE_TAR=ON -DENABLE_XATTR=OFF -DLIBXML2_INCLUDE_DIR=OFF -DLIBXML2_LIBRARIES=OFF -DLIBXML2_XMLLINT_EXECUTABLE=OFF -DEXPAT_INCLUDE_DIR=OFF -DEXPAT_LIBRARY=OFF -DICONV_INCLUDE_DIR=OFF ${XZ_CMAKE} ${BZIP2_CMAKE} ${ZLIB_CMAKE} ${ARCHIVE})
LINUX_DKQCOMMAND(make archive_static)

RASPBERRY_DKQCOMMAND(${DKCMAKE_BUILD} -DENABLE_TEST=OFF -DENABLE_ACL=OFF -DENABLE_CPIO=OFF -DENABLE_CNG=OFF -DENABLE_ICONV=OFF -DENABLE_NETTLE=OFF -DENABLE_OPENSSL=OFF -DENABLE_TAR=ON -DENABLE_XATTR=OFF -DLIBXML2_INCLUDE_DIR=OFF -DLIBXML2_LIBRARIES=OFF -DLIBXML2_XMLLINT_EXECUTABLE=OFF -DEXPAT_INCLUDE_DIR=OFF -DEXPAT_LIBRARY=OFF -DICONV_INCLUDE_DIR=OFF ${XZ_CMAKE} ${BZIP2_CMAKE} ${ZLIB_CMAKE} ${ARCHIVE})
RASPBERRY_DKQCOMMAND(make archive_static)

ANDROID_DKQCOMMAND(${DKCMAKE_BUILD} "-DCMAKE_C_FLAGS=-I${ARCHIVE}/${OS} -I${ARCHIVE}/contrib/android/include -I${ZLIB}/${OS}" -DENABLE_BZip2=OFF -DUSE_BZIP2_DLL=OFF -DBUILD_TESTING=OFF -DENABLE_TEST=OFF -DENABLE_ACL=OFF -DENABLE_CPIO=OFF -DENABLE_CNG=OFF -DENABLE_EXPAT=OFF -DENABLE_ICONV=OFF -DENABLE_LIBXML2=OFF -DENABLE_NETTLE=OFF -DENABLE_OPENSSL=OFF -DENABLE_TAR=OFF -DENABLE_XATTR=OFF -DLIBXML2_INCLUDE_DIR=OFF -DLIBXML2_LIBRARIES=OFF -DLIBXML2_XMLLINT_EXECUTABLE=OFF -DEXPAT_INCLUDE_DIR=OFF -DEXPAT_LIBRARY=OFF -DICONV_INCLUDE_DIR=OFF -DENABLE_LibGCC=OFF -DENABLE_LIBB2=OFF -DENABLE_CAT=OFF -DENABLE_LZ4=OFF -DENABLE_PCREPOSIX=OFF -DENABLE_ZSTD=OFF ${XZ_CMAKE} ${BZIP2_CMAKE} ${ZLIB_CMAKE} ${ARCHIVE})
ANDROID_VS(${ARCHIVE_NAME} libarchive.sln archive_static)
