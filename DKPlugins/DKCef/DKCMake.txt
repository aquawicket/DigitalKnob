IF(ANDROID)
	RETURN()
ENDIF()
IF(IOSSIM)
	RETURN()
ENDIF()

DKDEPEND(DKDuktape)

DKSET(QUEUE_BUILD ON)

IF(WIN_32)
	DKDEPEND(cef_binary_3.2987.1601.gf035232_windows32)
ENDIF()
IF(WIN_64)
	DKDEPEND(cef_binary_3.2987.1601.gf035232_windows64)
ENDIF()
IF(LINUX_32)
	DKDEPEND(cef_binary_3.2987.1601.gf035232_linux32)
ENDIF()
IF(LINUX_64)
	DKDEPEND(cef_binary_3.2987.1601.gf035232_linux64)
ENDIF()
IF(MAC_64)
	DKDEPEND(cef_binary_3.2987.1601.gf035232_macosx64)
ENDIF()
IF(WIN)
	DKDEPEND(upx391w)
ENDIF()
IF(LINUX)
	DKDEPEND(libgtk2.0-dev)
ENDIF()


DKPLUGIN(DKCef)
DKASSETS(DKCef)


IF(WIN_32)
	DKCOPY(${CEF}/Resources/ ${DKPROJECT}/assets/DKCef TRUE)
	IF(DEBUG)
		DKCOPY(${CEF}/Debug/ ${DKPROJECT}/assets/DKCef/win32Debug TRUE)
		DKCOPY(${CEF}/Resources/icudtl.dat ${DKPROJECT}/assets/DKCef/win32Debug TRUE)
		FILE(REMOVE ${DKPROJECT}/assets/DKCef/win32Debug/cef_sandbox.lib)
		FILE(REMOVE ${DKPROJECT}/assets/DKCef/win32Debug/libcef.lib)
		FILE(REMOVE ${DKPROJECT}/assets/DKCef/win32Debug/wow_helper.exe)
		
	ENDIF()
	IF(RELEASE)
		UPX_COMPRESS(${CEF}/Release/libcef.dll)
		DKCOPY(${CEF}/Release/ ${DKPROJECT}/assets/DKCef/win32Release TRUE)
		DKCOPY(${CEF}/Resources/icudtl.dat ${DKPROJECT}/assets/DKCef/win32Release TRUE)
		FILE(REMOVE ${DKPROJECT}/assets/DKCef/win32Release/cef_sandbox.lib)
		FILE(REMOVE ${DKPROJECT}/assets/DKCef/win32Release/libcef.lib)
		FILE(REMOVE ${DKPROJECT}/assets/DKCef/win32Release/wow_helper.exe)
		##FILE(REMOVE ${DKPROJECT}/assets/DKCef/win32Release/d3dcompiler_47.dll)
		##FILE(REMOVE ${DKPROJECT}/assets/DKCef/win32Release/d3dcompiler_43.dll)
		##FILE(REMOVE ${DKPROJECT}/assets/DKCef/win32Release/libGLESv2.dll)
	ENDIF()
	FILE(REMOVE ${DKPROJECT}/assets/DKCef/icudtl.dat)
	LIST(APPEND DEBUG_LINK_FLAGS /DELAYLOAD:libcef.dll)
	LIST(APPEND RELEASE_LINK_FLAGS /DELAYLOAD:libcef.dll)
	LIST(APPEND DEBUG_LINK_FLAGS /DELAYLOAD:chrome_elf.dll)
	LIST(APPEND RELEASE_LINK_FLAGS /DELAYLOAD:chrome_elf.dll)
	LIST(APPEND WIN_LIBS winmm.lib)
ENDIF()

IF(WIN_64)
	DKCOPY(${CEF}/Resources/ ${DKPROJECT}/assets/DKCef TRUE)
	IF(DEBUG)
		DKCOPY(${CEF}/Debug/ ${DKPROJECT}/assets/DKCef/win64Debug TRUE)
		DKCOPY(${CEF}/Resources/icudtl.dat ${DKPROJECT}/assets/DKCef/win64Debug TRUE)
		FILE(REMOVE ${DKPROJECT}/assets/DKCef/win64Debug/cef_sandbox.lib)
		FILE(REMOVE ${DKPROJECT}/assets/DKCef/win64Debug/libcef.lib)
		FILE(REMOVE ${DKPROJECT}/assets/DKCef/win64Debug/wow_helper.exe)
	ENDIF()
	IF(RELEASE)
		UPX_COMPRESS(${CEF}/Release/libcef.dll)
		DKCOPY(${CEF}/Release/ ${DKPROJECT}/assets/DKCef/win64Release TRUE)
		DKCOPY(${CEF}/Resources/icudtl.dat ${DKPROJECT}/assets/DKCef/win64Release TRUE)
		FILE(REMOVE ${DKPROJECT}/assets/DKCef/win64Release/cef_sandbox.lib)
		FILE(REMOVE ${DKPROJECT}/assets/DKCef/win64Release/libcef.lib)
		FILE(REMOVE ${DKPROJECT}/assets/DKCef/win64Release/wow_helper.exe)
		##FILE(REMOVE ${DKPROJECT}/assets/DKCef/win64Release/d3dcompiler_47.dll)
		##FILE(REMOVE ${DKPROJECT}/assets/DKCef/win64Release/d3dcompiler_43.dll)
		##FILE(REMOVE ${DKPROJECT}/assets/DKCef/win64Release/libGLESv2.dll)
	ENDIF()
	FILE(REMOVE ${DKPROJECT}/assets/DKCef/icudtl.dat)
	LIST(APPEND DEBUG_LINK_FLAGS /DELAYLOAD:libcef.dll)
	LIST(APPEND RELEASE_LINK_FLAGS /DELAYLOAD:libcef.dll)
	LIST(APPEND DEBUG_LINK_FLAGS /DELAYLOAD:chrome_elf.dll)
	LIST(APPEND RELEASE_LINK_FLAGS /DELAYLOAD:chrome_elf.dll)
	LIST(APPEND WIN_LIBS winmm.lib)
ENDIF()

IF(MAC_64)
	#DKCOPY(${CEF}/Release ${DKPROJECT}/assets/DKCef TRUE)
	FILE(MAKE_DIRECTORY ${DKPROJECT}/mac64/Debug/${AppName}.app/Contents/Frameworks)
	DKCOPY(${CEF}/Debug ${DKPROJECT}/mac64/Debug/${AppName}.app/Contents/Frameworks TRUE)
	FILE(MAKE_DIRECTORY ${DKPROJECT}/mac64/Release/${AppName}.app/Contents/Frameworks)
	DKCOPY(${CEF}/Release ${DKPROJECT}/mac64/Release/${AppName}.app/Contents/Frameworks TRUE)
	#FIND_LIBRARY(AK AppKit)
	#LIST(APPEND DEBUG_LIBS ${AK})
	#LIST(APPEND RELEASE_LIBS ${AK})

	#FIXME - command does not work because app does not exist yet
	MAC_COMMAND(install_name_tool -change "@executable_path/Chromium Embedded Framework" "@executable_path/../Frameworks/Chromium Embedded Framework.framework/Chromium Embedded Framework" "${DKPROJECT}/mac64/Debug/${AppName}.app/Contents/MacOS/${AppName}")
ENDIF()

IF(LINUX_32)
	IF(DEBUG)
		DKCOPY(${CEF}/Debug ${DKPROJECT}/assets/DKCef TRUE)
		DKCOPY(${CEF}/Resources/icudtl.dat ${DKPROJECT}/assets/DKCef TRUE)
		DKCOPY(${CEF}/Resources ${DKPROJECT}/assets/DKCef TRUE)
		DKCOPY(${CEF}/Debug ${DKPROJECT}/linux32/Debug TRUE)
		DKCOPY(${CEF}/Resources/icudtl.dat ${DKPROJECT}/linux32/Debug TRUE)
	ENDIF()
	
	IF(RELEASE)
		DKCOPY(${CEF}/Release ${DKPROJECT}/assets/DKCef TRUE)
		DKCOPY(${CEF}/Resources/icudtl.dat ${DKPROJECT}/assets/DKCef TRUE)
		DKCOPY(${CEF}/Resources ${DKPROJECT}/assets/DKCef TRUE)
		DKCOPY(${CEF}/Release ${DKPROJECT}/linux32/Release TRUE)
		DKCOPY(${CEF}/Resources/icudtl.dat ${DKPROJECT}/linux32/Release TRUE)
	ENDIF()
	
	FILE(REMOVE ${DKPROJECT}/assets/DKCef/cef_sandbox.a)
	FILE(REMOVE ${DKPROJECT}/assets/DKCef/libcef.a)
	FILE(REMOVE ${DKPROJECT}/assets/DKCef/wow_helper.exe)
ENDIF()

IF(LINUX_64)
	IF(DEBUG)
		DKCOPY(${CEF}/Debug ${DKPROJECT}/assets/DKCef TRUE)
		DKCOPY(${CEF}/Resources/icudtl.dat ${DKPROJECT}/assets/DKCef TRUE)
		DKCOPY(${CEF}/Resources ${DKPROJECT}/assets/DKCef TRUE)
		DKCOPY(${CEF}/Debug ${DKPROJECT}/linux64/Debug TRUE)
		DKCOPY(${CEF}/Resources/icudtl.dat ${DKPROJECT}/linux64/Debug TRUE)
	ENDIF()
	
	IF(RELEASE)
		DKCOPY(${CEF}/Release ${DKPROJECT}/assets/DKCef TRUE)
		DKCOPY(${CEF}/Resources/icudtl.dat ${DKPROJECT}/assets/DKCef TRUE)
		DKCOPY(${CEF}/Resources ${DKPROJECT}/assets/DKCef TRUE)
		DKCOPY(${CEF}/Release ${DKPROJECT}/linux64/Release TRUE)
		DKCOPY(${CEF}/Resources/icudtl.dat ${DKPROJECT}/linux64/Release TRUE)
	ENDIF()
	
	FILE(REMOVE ${DKPROJECT}/assets/DKCef/cef_sandbox.a)
	FILE(REMOVE ${DKPROJECT}/assets/DKCef/libcef.a)
	FILE(REMOVE ${DKPROJECT}/assets/DKCef/wow_helper.exe)
ENDIF()